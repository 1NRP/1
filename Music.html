<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <meta name="theme-color" content="#02121b">
  <link rel="icon" sizes="192x192" href="https://1nrp.github.io/1/Images/N-Logo1.png">
  <title> Music Player </title>
<style>
body {
  background-color: #0d2136;
  color: #fff;
  scrollbar-width: none;
}
#player {
  border: 4px solid #6aa8;
  border-radius: 50px;
  background: linear-gradient(30deg, #800, #080, #008);
  background-color: #08f;
  width: 94vw;
  max-height: 10vh;
  margin: -4px 0px 2px 0px;
}
#header {
  align-items:center;
  display:flex;
  flex-direction:row;
  border:2px dashed #358;
  width:99%;
  height:5vh;
}
#txtBox {
  border:none;
  color:#863;
  resize: none;
  height: 80%;
  scrollbar-width: none;
  background-color:#021133;
  width:80%;
  font-family: arial, monospace, cursive, sans-serif;
  outline: 0;
  font-weight: 400;
  font-size: 22px;
}
#loadBtn:hover {
  background-color: #223344;
}
#hamburgerMenu {
  position: absolute;
  bottom: 10px;
  z-index: 100;
  right: 10px;
  font-size: 14px;
  padding: 8px 12px;
  font-weight: 1000;
  transition: transform 0.4s ease;
  color: #e2df12;
  border: 2px solid #7c7676;
  border-radius: 50px;
  background-color: #470505b4;
}
#loadBtn {
  border:none;
  width:20%;
  height: 100%;
  font-weight: 900;
  background-color:#345;
  font-size:20px;
  color:#369
}
::placeholder {
  color: #848484;
}
.channelName {
  color: #12777a;
  font-weight: 700;
  font-size: 14px; 
  font-family: monospace, sans-serif; 
  text-align: left
}
.songName {
  color: #915959;
  font-weight: 700;
  font-size: 16px; 
  font-family: Arial, sans-serif; 
  text-align: left; 
}
#viewBox {
  width: 99%;
  height: 80vh;
  border-radius: 4px;
  border: 2px solid #333;
  overflow-y: scroll;
  scrollbar-width: none;
  background: linear-gradient(140deg, #02364b, #793c04);
  margin: 4px 0px 2px 0px;
  display: flex;
  flex-wrap: wrap;
  overflow-x: auto;
  flex-direction: row;
}
.selectOptions {
  font-weight: 600;
  color: #b4b4b4;
  border: 2px dotted #555;
  border-radius: 4px;
  background-color: #02121b;
  width: 90px;
  padding: 2px;
}
.toolBar {
  position: fixed;
  bottom: 10px;
  left: 10px;
  width: 90vw;
  padding: 4px;
  background: linear-gradient(140deg, #006, #060);
  border: solid 2px #04348f;
  margin: 2px;
  border-radius: 10px;
  z-index: 20;
  font-family: Arial, Courier, monospace, sans-serif;
  font-size: 12px;
  font-weight: 600;
  animation: Toolbar 0.5s ease;
}
.blurElements {
  filter: blur(10px);
}
.imgBox {
  max-width: 100%;
  min-width: 45%;
  display: flex;
  flex-direction: column;
  margin: 2px;
}
.image {
  height: auto;
  border-radius: 4px;
}
.loader {
  position: fixed;
  top: 40%;
  width: 40%;
  left: calc( (100% - 40%) / 2 );
  display: inline-grid;
  z-index: 10;
  aspect-ratio: 1;
  clip-path: polygon(100% 50%,85.36% 85.36%,50% 100%,14.64% 85.36%,0% 50%,14.64% 14.64%,50% 0%,85.36% 14.64%);
  /* clip-path: square; */
  /* clip-path: polygon(100% 50%, 50% 100%, 0% 50%, 50% 0%); */
  background: #ce0404;
  animation: Loading 2s infinite linear;
}
.loader:before,
.loader:after {
  content:"";
  grid-area: 1/1;
  background: #08ebeb;
  clip-path: inherit;
  margin: 10%;
  animation: inherit;
  animation-duration: 8s;
}
.changePage {
  border: 2px solid #8e9eee;
  padding: 0px 20%;
  margin:5px;
  border-radius: 30px;
  background-color: #02121b;
  font-size: 30px;
  font-weight: 800;
  color: #940
}
.loader:after {
  background: #043772;
  margin: 25%;
  animation-duration: 12s;
}
.removing {
  animation: slideOut 0.5s ease-out forwards;
}

@keyframes Toolbar { 
  from { opacity: 0; bottom: -10% } 
  to { opacity: 1; bottom: 4% }
}

@keyframes Loading {
  to { rotate: 1turn } 
}

@keyframes slideOut {
  from { transform: translateX(0);opacity: 1 }
  to { transform: translateX(100%); opacity: 0}
}

</style>
</head>
<body>
  <div id="loading"></div>
  
  <audio id="player" onended="PlayNextSong()" controls tabindex="0" src="" width="100%" autoplay ></audio> <!-- loop="loop" -->

  <div id="header">
    <textarea id='txtBox' placeholder="Example: Kaabil" value=""></textarea>
    <button id='loadBtn' onclick="ViewImages()">LOAD</button>
  </div>

  <button id="hamburgerMenu" onclick="ToggleToolbar(); style.transform = (style.transform === 'rotate(180deg)' ? 'rotate(0deg)' : 'rotate(180deg)');">â˜°</button>
  <div id="viewBox" ondblclick=" document.getElementById('player').src = ''; ThirdPartyAPI = ThirdPartyAPI === true ? false : true" > </div>
  
  <div id="toolBar" class="toolBar" style="display: none">

    <!-- <b style="color: #fff222"> Response Type : </b>
    <select id="responseType" class="selectOptions">
      <option value="video">Video</option>
      <option value="channel">Channel</option>
      <option value="playlist">Playlist</option>
    </select> -->
    <button class="changePage" onclick="ChangePage('Previous')"> < </button>
    <button class="changePage" onclick="ChangePage('Next')"> > </button>
    <br>
    <input type="checkbox" id="thirdPartyApi" checked style="transform: translateY(20%)" ></input>
    <b style="color: #fff222"> Third Party API </b>
    <br></br>
    
    <input type="checkbox" id="autoPlay" checked style="transform: translateY(20%)" ></input>
    <b style="color: #fff222"> Auto-Play Next </b>
    <br></br>
    
    <input type="checkbox" id="corsProxy" checked style="transform: translateY(20%)" ></input>
    <b style="color: #fff222"> Use CORS Proxy </b>
    <br></br>
    <!-- <br> -->
    <input  checked type="radio" id="type1" name="chooseType" value="video" style="transform: translateY(20%)" >
      <label for="type1" style="color: #fff222" > Video </label>
    <input type="radio" id="type2" name="chooseType" value="playlist" style="transform: translateY(20%)" >
      <label for="type2" style="color: #fff222"> Playlist </label> 
    <input type="radio" id="type3" name="chooseType" value="channel" style="transform: translateY(20%)" >
      <label for="type3" style="color: #fff222" > Channel </label>
  </div>

<script>

// Get Element By ID Shortcut (Jquery Style).
const ID = (elementId) => document.getElementById(elementId);

const state = { 
  currentJson: [],
  currentSong: '',
  touchstartX: 0,
  touchendX: 0,
  paginationTokens: [],
  currentPaginationToken: '',
  touchedElement: null
}

// Fetch JSON and view thumbnails.
async function ViewImages(playlist = null) {
  const type = ID('type1').checked ? 'video' : ID('type2').checked ? 'playlist' : ID('type3').checked ? 'channel' : null;
  const songName = ID('txtBox').value.trim() || 'Kaabil Song';
  Loading('Show');
  let url = type === 'playlist' ? 'https://1nrp.val.run/songList' + '?query=' + songName + '&type=playlist' : 'https://1nrp.val.run/songList' + '?query=' + songName + '&type=video';
  url = playlist ? 'https://1nrp.val.run/songList?type=getPlaylistItems' + '&id=' + playlist : url;
  const req = await fetch(url);
  const media = await req.json();
  Loading('Hide');
  state.currentJson = media;
  ID('viewBox').innerHTML = '';
  ID('viewBox').style.background = !playlist && type === 'playlist' ? "linear-gradient(270deg, #792504, #031a44)" : "linear-gradient(140deg, #02364b, #793c04)";
  let count = 1;
  for ( const song of media ) {
      const { videoId, playlistId, title, channelTitle, thumbnail } = song;
      const box = document.createElement('div');
      box.className = 'imgBox';
      const imageHtmlLine = playlistId
        ? ` <img src="${thumbnail}" onclick="ViewImages('${playlistId}')" alt="Thumbnail Image" class="image"> `
        : ` <img src="${thumbnail}" onclick="PlayAudio('${videoId}')" alt="Thumbnail Image" class="image"> `;
        box.innerHTML = ` 
        ${imageHtmlLine}
        <span class="songName">${count} - ${title}</span>
        <span class="channelName">${channelTitle}</span>
      `;
      ID('viewBox').appendChild(box);
      count++;
  }
}

function PlayNextSong() {
  const autoPlay = ID('autoPlay').checked;
  const { currentJson, currentSong } = state;
  const lastPlayed = currentJson.findIndex(song => song.videoId === currentSong);
  currentJson.splice(lastPlayed, 1);
  const nextSong = lastPlayed + 1 < currentJson.length ? currentJson[lastPlayed + 1] : currentJson[0];
  if (!autoPlay || !nextSong) return;
  PlayAudio(nextSong.videoId);
};

async function PlayAudio(videoId) {
    Loading('Show');
    const ThirdPartyAPI = ID('thirdPartyApi').checked;
    const useCors = ID('corsProxy').checked;
    const url = !ThirdPartyAPI 
                ? 'https://1nrp.val.run/songUrl' + '?vid=' + videoId
                : !useCors
                  ? 'https://api.vreden.my.id/api/v1/download/youtube/audio?url=https://www.youtube.com/watch?v=' + videoId + '&quality=128' 
                  : new Request('https://cors.1nrp.workers.dev/?URL=' + encodeURIComponent('https://api.vreden.my.id/api/v1/download/youtube/audio?url=https://www.youtube.com/watch?v=' + videoId + '&quality=128'), { headers: {'Authorization': localStorage.getItem('M3U8-Access-Token') ?? prompt('Enter Cloudflare CORS Proxy Access Token :')} });
    const res = await fetch(url);
    const data = await res.json();
    Loading('Hide');
    const link = data.link ?? data.result.download.url;
    const player = ID('player');
    player.src = link;
    const { title = 'Default' } = state.currentJson.find(song => song.videoId === videoId);
    ID('txtBox').value = '';
    ID('txtBox').placeholder = title;
    ID('player').play();
    state.currentSong = videoId;
}

function Loading(status) {
  const blurElems = ['player', 'header', 'viewBox'];
  if (status === 'Show') {
    ID('loading').className = 'loader';
    blurElems.forEach((element) => ID(element).className = 'blurElements');
  } else {
    ID('loading').className = '';
    for (const element of blurElems) { ID(element).className = '' }
  }
}

function ChangePage(dir) {
  const { paginationTokens: pages, currentPaginationToken: token } = state;
  const nowToken = dir === 'Next' ? pages.at(-1) : pages[pages.indexOf(token) + 1];
}

function ToggleToolbar() {
    const toolbar = ID('toolBar');
    const status = toolbar.style.display;
    toolbar.style.display = status === 'none' ? 'block' : 'none';
}

function RearrangeImages() {
  const { currentJson: media } = state;
  for ( const song of media ) {
      const { videoId, playlistId, title, channelTitle, thumbnail } = song;
      const box = document.createElement('div');
      box.className = 'imgBox';
      const imageHtmlLine = playlistId
        ? ` <img src="${thumbnail}" onclick="ViewImages('${playlistId}')" alt="Thumbnail Image" class="image"> `
        : ` <img src="${thumbnail}" onclick="PlayAudio('${videoId}')" alt="Thumbnail Image" class="image"> `;
        box.innerHTML = ` 
        ${imageHtmlLine}
        <span class="songName">${count} - ${title}</span>
        <span class="channelName">${channelTitle}</span>
      `;
      ID('viewBox').appendChild(box);
      count++;
  }
}

// Slide to remove.
ID('viewBox').addEventListener('touchstart', function(event) {
    if (event.touches.length === 1) { // single touch
        state.touchedElement = event.target.closest('.imgBox');
        if (state.touchedElement) {
            state.touchstartX = event.touches[0].clientX;
        }
    }
}, false);

ID('viewBox').addEventListener('touchmove', function(event) {
    if (state.touchedElement && event.touches.length === 1) {
        const touchX = event.touches[0].clientX;
        const deltaX = touchX - state.touchstartX;
        if (deltaX > 0) { // right swipe
             state.touchedElement.style.transform = `translateX(${deltaX}px)`;
        }
    }
}, false);

ID('viewBox').addEventListener('touchend', function(event) {
    if (state.touchedElement) {
        state.touchendX = event.changedTouches[0].clientX;
        const deltaX = state.touchendX - state.touchstartX;

        if (deltaX > 100) { // threshold
            state.touchedElement.classList.add('removing');

            state.touchedElement.addEventListener('animationend', () => {
                const onclickAttr = state.touchedElement.querySelector('img').getAttribute('onclick');
                const idMatch = onclickAttr.match(/'([^']*)'/);
                if (idMatch && idMatch[1]) {
                    const id = idMatch[1];
                    const indexToRemove = state.currentJson.findIndex(song => song.videoId === id || song.playlistId === id);

                    if (indexToRemove > -1) {
                        state.currentJson.splice(indexToRemove, 1);
                    }
                }
                state.touchedElement.remove();
            });
            RearrangeImages();

        } else {
            // Spring back if not swiped far enough.
            state.touchedElement.style.transform = '';
        }
    }
    state.touchedElement = null;
    state.touchstartX = 0;
    state.touchendX = 0;
}, false);

</script>
</body>
</html>
