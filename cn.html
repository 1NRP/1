<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" sizes="192x192" href="https://1nrp.github.io/1/Images/N-Logo1.png">
  <meta charset="utf-8">
  <meta name="theme-color" content="#02121b">
  <title>Cloud Notes</title>
</head>
<style>
body {
    color: #fff;
    background-color: #000;
}
input:focus,
textarea:focus,
select:focus {
  outline:0
}
h2 {
    font-family: cursive, arial, sans-serif;
    font-size: 25px;
    font-weight: 900;
    margin: -8px 0px 2px 0px;
}
#TopBar {
    display: flex;
    flex-direction: row;
}
#Stores {
    padding: 2px 2px;
    border: 2px solid #555;
    border-radius: 40px;
    width: 80px;
    position: absolute;
    color: #fff;
    background-color: #000;
    margin: -6px 0px 0px 70vw;
    font-weight: 500;
}
#textBox {
    width: 96%;
    height: 85vh;
    padding: 6px;
    font-family: sans-serif;
    font-size: 15px;
    resize: none;
    overflow: auto;
    background-color: #111136;
    border: none;
    color: #fff;
    border-radius: 6px;
}
#deleteBox {
    color: #fff;
    height: auto;
    min-height: 10%;
    resize: none;
    overflow: auto;
    box-sizing: border-box;
    width: 100%;
    overflow: scroll;
    background-color: #361923;
    border: 2px solid #444;
    border-radius: 6px;
}
#deleteButton {
    background-color: #802;
    color: #b4b4b4;
    border: none;
    font-size: 15px;
    border-radius: 50px;
    padding: 6px 8px;
    font-weight: 900;
    margin: 0px 2px 4px 0px;
}
#saveButton {
    background-color: #205c89;
    color: #b4b4b4;
    border: none;
    font-size: 15px;
    border-radius: 50px;
    padding: 6px 8px;
    font-weight: 900;
    margin: 2px 2px 0px 15%;
}
#getButton {
    background-Color: #761;
    color: #b4b4b4;
    border: none;
    border-radius: 50px;
    font-size: 15px;
    font-weight: 900;
    padding: 6px 8px;
    margin: 2px 2px 0px 15px;
}
#clearButton {
    border: none;
    color: #b4b4b4;
    border-radius: 50px;
    background-color: #833;
    padding: 2px 7px 5px 7px;
    margin: 0px 0px 0px 15%;
}
#clearButton:hover,
#getButton:hover,
#deleteButton:hover,
#saveButton:hover {
    background-color: #444;
}
.Alerts {
    position: fixed;
   /* top: 5dvh; */
    left: 15dvw;
    background-color: #fff;
    color: #000;
    font-weight: 900;
    padding: 5px 5px;
    border: none;
    border-radius: 5px;
    animation-name: Alert;
    animation-duration: 1s;
}
 /* Alert Animation */
@keyframes Alert {
    from {font-size: 10px; top: 5dvh}
    to {font-size: 25px; top: 10dvh}
}
</style>
<body>
<!--  * Keyboard Shortcuts: Fetch Notes: "ArrowRight + ArrowDown", Save Notes: "ArrowRight + ArrowUp", Delete Notes: "ArrowRight + End"  -->
<div id="TopBar">
    <h2 id="Header">Nihar's Cloud Notes</h2>
    <div id='loginStatus' style="padding:1px;height:20px;width:20px; position: absolute; background-color:#d00; border-radius:50px;margin:-1vw 0px 0px 60vw"></div>"
    <select id="Stores">
        <option value="Miscellaneous" data-Name="Nihar's Cloud Notes" data-Colour="#111136">Miscellaneous</option>
        <option value="Trading_And_Investing" data-Name="Trading & Investing" data-Colour="#4e3144">Trading & Investing</option>
        <option value="Important_Webpages" data-Name="Important Webpages" data-Colour="#395c42">Important Webpages</option>
        <option value="Movie_Watch_List" data-Name="Movie Watch List" data-Colour="#503959">Movie Watch List</option>
        <option value="Book_Summaries" data-Name="Book Summaries" data-Colour="#664337">Book Summaries</option>
        <option value="TG_Channels" data-Name="TG Channels" data-Colour="#376661">TG Channels</option>
        <option value="To_Do_List" data-Name="To Do List" data-Colour="#364b57">To Do List</option>
        <option value="Keywords" data-Name="Keywords" data-Colour="#272729">Keywords</option>
        <option value="Book_List" data-Name="Book List" data-Colour="#8c7842">Book List</option>
        <option value="Quotes" data-Name="Quotes" data-Colour="#1d423a">Quotes</option>
    </select>
</div>
    <div id="pop-up" style="display: none;">
      <button id="login" style="background-color: #2072b1; padding: 6px; border: 2px dashed #3c3f3d; border-radius: 6px;" onclick="login()">LOG IN</button>
      <button id="logout" style="background-color: #c02020; padding: 6px; border: 2px dashed #3c3f3d; border-radius: 6px;" onclick="logout()">LOG OUT</button>
    </div>
    <textarea id="textBox" spellcheck="false" autocomplete="off" translate="no"></textarea> 
    <button id="deleteButton" onclick="deleteNote()">DELETE</button>
    <button id="clearButton" onclick="document.getElementById('textBox').value=''" ondblclick="document.getElementById('pop-up').style.display = (document.getElementById('pop-up').style.display === 'none' ? 'block' : 'none');">✖</button>
    <button id="saveButton" onclick="saveNote()">SAVE</button>
    <button id="getButton" onclick="getNotes()">VIEW</button>
    <textarea id="deleteBox" spellcheck="false" autocomplete="off" translate="no"></textarea>

<script type="module">
// Button click Event-Listeners.
document.getElementById('saveButton').onclick = saveNote;
document.getElementById('getButton').onclick = getNotes;
document.getElementById('deleteButton').onclick = deleteNote;
document.getElementById('textBox').onclick = pasteLineText;
document.getElementById('login').onclick = login;
document.getElementById('logout').onclick = logout;

// Import necessary functions from Firebase SDKs.
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, arrayUnion, arrayRemove, updateDoc, enableIndexedDbPersistence, getDocFromCache } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyAwh2IXpNUCL2JHuTLKfc8FZDDd62g4j74", authDomain: "nrp888.firebaseapp.com", projectId: "nrp888", storageBucket: "nrp888.firebasestorage.app", messagingSenderId: "876054763342", appId: "1:876054763342:web:fddead6f7db3f8ebcff01f" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Enable Offline Persistence if Trusted Device while logging in.
function login() {
  const auth = getAuth();
  const email = prompt('Enter Email:');
  const password = prompt('Enter Password:');
  const offlineSupport = prompt('Is it a Trusted Device ? Click "OK" to enable offline persistence and "CANCEL" to disable.', "Yes");
  signInWithEmailAndPassword(auth, email, password)
    .then((userCredential) => {
    // Signed in.
      const user = userCredential.user;
      showAlert({ BgColor: '#1bd13d', Text: '✔ Logged In'});
    })
    .catch((error) => {
      alert(error.message);
    });
  if (offlineSupport === "Yes") {
    initializeFirestore(app, { localCache: persistentLocalCache({ tabManager: persistentSingleTabManager() })
  }).catch((err) => {
    if (err.code === 'unimplemented') {
      alert('The current browser does not support all of the features required to enable persistence');
    }
  });
}
}

// Check login status.
let loggedIn = false; // Global Login-Status variable.
function loginStat() {
  const auth = getAuth();
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const statBtn = document.getElementById('loginStatus');
      const userId = user.uid;
      loggedIn = true;
      statBtn.style.backgroundColor = '#0d0';
    } else {
      // User is signed out.
      statBtn.style.backgroundColor = '#d00';
    }
  });
}
window.onload = loginStat();
  
// Logout.
function logout() {
  const auth = getAuth();
  signOut(auth).then(() => {
    showAlert({ BgColor: '#f2074e', Text: '✖ Logged Out'});
  }).catch((error) => {
    showAlert({ BgColor: '#e8af05', Text: '⚠ Error Logging Out'});
  });
}

// SaveNote.
    async function saveNote() {
      if (loggedIn) {
        try {
            const Redis_Key = document.getElementById('Stores').value;
            const fireDB = doc(db, "Notes_Collection", `${Redis_Key}`);
            const AlertText = document.getElementById('Header').innerText;
            const lines = document.getElementById('textBox').value.trim().split('\n\n\n\n');
            const date  = `● Date: ${new Date().toLocaleDateString('en-IN')} ●`;
            const saveSentence = date + "\n" + lines[lines.length - 1];
            if (lines && saveSentence) {
              await updateDoc(fireDB, { Notes: arrayUnion(saveSentence) });
            }
            console.log("Note saved to Firestore:", saveSentence)
            await updateDoc(fireDB, { Notes: arrayUnion(saveSentence) });
            console.log("Note saved to Firestore:", saveSentence);
            //showAlert({ BgColor: '#1bd13d', Text: `✔ ${AlertText}`});
            //showAlert({ BgColor: '#f2074e', Text: `✖ ${AlertText}`});
            //showAlert({ BgColor: '#e8af05', Text: `⚠ ${AlertText}`});
        } catch (error) {
          console.error("Error saving note:", error);
        }
      } else {
        login();
      }
    }

// DeleteNote.
   async function deleteNote() {
      if (loggedIn) {
        try {
          const Redis_Key = document.getElementById('Stores').value;
          const fireDB = doc(db, "Notes_Collection", `${Redis_Key}`);
          const AlertText = document.getElementById('Header').innerText;
          const deleteSentence = document.getElementById('deleteBox').value.trim();
          if (deleteSentence) {
            await updateDoc(fireDB, { Notes: arrayRemove(deleteSentence) });
          }
          console.log("Note deleted from Firestore.");
        } catch (error) {
          console.error("Error deleting note:", error);
        }
      } else {
          login();
      }
    }

// GetNote.
    async function getNotes() {
      if (loggedIn) {
        try {
          const Redis_Key = document.getElementById('Stores').value;
          const fireDB = doc(db, "Notes_Collection", `${Redis_Key}`);
          const getNote = await getDoc(fireDB);
          if (getNote.exists()) {
            document.getElementById('textBox').value = getNote.data().Notes.reverse().join('\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\n');
          } else {
            // getNote.data() will be undefined in this case.
            console.log("No such document!");
          }
        } catch (error) {
            console.log("Error: ", error);
        }
      } else {
          // Trigger Login Function.
          login();
          }
      }
    

// Function to paste specific note into deleteBox. 
function pasteLineText(event) {
    var textBox = document.getElementById('textBox');
    var text = textBox.value;
    var cursorPosition = textBox.selectionStart; // Get cursor position
    // Find the nearest start line before the cursor position
    var startLine = text.lastIndexOf('\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\n', cursorPosition);
    // Find the nearest end line after the cursor position
    var endLine = text.indexOf('\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\n', cursorPosition);
    // Adjust start and end positions to get the text between them
    var startOfLine = startLine + '\n=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=\n'.length;
    var endOfLine = endLine;
    // If no start line is found before the cursor position, start from the beginning
    if (startLine === -1 || cursorPosition < startLine) {
        startOfLine = 0; }
    // If no end line is found after the cursor position, select till the end of text
    if (endLine === -1 || cursorPosition > endLine) {
        endOfLine = text.length; }
    var lineText = text.substring(startOfLine, endOfLine);
    document.getElementById('deleteBox').value = lineText;
}
  
// Global Variables to contain Stores' properties.
document.getElementById('Stores').addEventListener('change', function() {
    var dropdown = document.getElementById('Stores');
    var chosenStore = dropdown.options[dropdown.selectedIndex];
    var Name = chosenStore.getAttribute('data-Name');
    var Colour = chosenStore.getAttribute('data-Colour');
    document.getElementById('textBox').style.backgroundColor = Colour;
    document.getElementById('Header').innerText = Name;  
});

// Auto expand deleteBox if texts overflow while typing or pasting, to properly see what will be deleted.
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.getElementById('deleteBox');
  textarea.addEventListener('input', function() {
    this.style.height = 'auto'; // Reset the height
    this.style.height = this.scrollHeight + 'px'; // Set the height to the scroll height
  });
  // Trigger input event to adjust height if there's initial content.
  textarea.dispatchEvent(new Event('input'));
});

// Show Alerts depending upon the response received.
function showAlert({ BgColor = '#fff', Text = 'Alert' } = {}) {
    var alertBox = document.createElement('div');
    alertBox.className = 'Alerts';
    alertBox.style.backgroundColor = BgColor;
    alertBox.textContent = Text;
    document.body.appendChild(alertBox);
    setTimeout(() => { 
        alertBox.remove(); 
    }, 1000);
  }

// Keyboard Shortcuts for different Functions.
let arrowRightPressed = false;
document.addEventListener("keydown", function(event) {
    if (event.key === "ArrowRight") {
        arrowRightPressed = true;
    }
    if (arrowRightPressed) {
        if (event.key === "ArrowUp") {
            saveNote();
        } else if (event.key === "ArrowDown") {
            getNotes();
        } else if (event.key === "End") {
            deleteNote();
        }
    }
});
document.addEventListener("keyup", function(event) {
    if (event.key === "ArrowRight") {
        arrowRightPressed = false;
    }
});

</script>
</body>
</html>
